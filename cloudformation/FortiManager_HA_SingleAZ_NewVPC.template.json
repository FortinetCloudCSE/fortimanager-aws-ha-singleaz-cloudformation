{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "(v9.0) AWS CFT to deploy a FortiManager HA pair into a new VPC",
	"Metadata": {
		"AWS::CloudFormation::Interface": {
			"ParameterGroups": [
				{
					"Label": {
						"default": "VPC Configuration"
					},
					"Parameters": [
						"VPCCIDR",
						"AZForSubnet1",
						"AZForSubnet2",
						"PublicSubnet1",
						"PrivateSubnet1",
						"PublicSubnet2",
						"PrivateSubnet2"
					]
				},
				{
					"Label": {
						"default": "TGW Configuration"
					},
					"Parameters": [
						"TgwAttach",
						"TransitGateway",
						"TransitGatewaySecurityRtb",
						"TransitGatewaySpokeRtb"
					]
				},
				{
					"Label": {
						"default": "FortiManager Instance Configuration"
					},
					"Parameters": [
						"InstanceType",
						"CIDRForInstanceAccess",
						"KeyPair",
						"EncryptVolumes",
						"FortiManagerVersion",
						"LicenseType",
						"InitS3Bucket",
						"FortiManager1SerialNumber",
						"FortiManager2SerialNumber",
						"FortiManager1LicenseFile",
						"FortiManager2LicenseFile",
						"FortiManager1FortiFlexToken",
						"FortiManager2FortiFlexToken"
					]
				},
				{
					"Label": {
						"default": "Interface IP Configuration for FortiManager1"
					},
					"Parameters": [
						"FortiManager1PrimaryIP"
					]
				},
				{
					"Label": {
						"default": "Interface IP Configuration for FortiManager2"
					},
					"Parameters": [
						"FortiManager2PrimaryIP"
					]
				},
				{
					"Label": {
						"default": "Interface IP Configuration for the Cluster"
					},
					"Parameters": [
						"ClusterIP"
					]
				}
			]
		}
	},
	"Parameters": {
		"VPCCIDR": {
			"Type": "String",
			"Default": "10.1.0.0/16",
			"Description": "Provide a network CIDR for the VPC",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"AZForSubnet1": {
			"Type": "AWS::EC2::AvailabilityZone::Name",
			"Description": "Select an Availability Zone for the first set of new subnets"
		},
		"AZForSubnet2": {
			"Type": "AWS::EC2::AvailabilityZone::Name",
			"Description": "Select an Availability Zone for the second set of new subnets"
		},
		"PublicSubnet1": {
			"Type": "String",
			"Default": "10.1.1.0/24",
			"Description": "[Provide a network CIDR for PublicSubnet1",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"PrivateSubnet1": {
			"Type": "String",
			"Default": "10.1.2.0/24",
			"Description": "Provide a network CIDR for PrivateSubnet1",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"PublicSubnet2": {
			"Type": "String",
			"Default": "10.1.10.0/24",
			"Description": "Provide a network CIDR for PublicSubnet2",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"PrivateSubnet2": {
			"Type": "String",
			"Default": "10.1.20.0/24",
			"Description": "Provide a network CIDR for PrivateSubnet2",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"TgwAttach": {
			"Type": "String",
			"Description": "Select Yes if you plan to attach this VPC to Transit GW with a VPC attachment, otherwise select No",
			"AllowedValues": [
				"Yes",
				"No"
			]
		},
		"TransitGateway": {
			"Type": "String",
			"Description": "[Leave blank if TGW will not be used] Provide the Transit GW ID to attach to"
		},
		"TransitGatewaySecurityRtb": {
			"Type": "String",
			"Description": "[Leave blank if TGW will not be used] Provide the Transit GW RouteTable ID that the security VPC is associated to"
		},
		"TransitGatewaySpokeRtb": {
			"Type": "String",
			"Description": "[Leave blank if TGW will not be used] Provide the Transit GW RouteTable ID that your spoke VPCs will be associated to"
		},
		"FortiManager1PrimaryIP": {
			"Type": "String",
			"Default": "10.1.1.10/24",
			"Description": "Provide the primary IP address in CIDR form for FortiManager1 to use (IP from PublicSubnet1)",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"FortiManager2PrimaryIP": {
			"Type": "String",
			"Default": "10.1.1.11/24",
			"Description": "Provide the primary IP address in CIDR form for FortiManager2 to use (IP from PublicSubnet1)",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"ClusterIP": {
			"Type": "String",
			"Default": "10.1.1.12/24",
			"Description": "Provide the secondary IP address in CIDR form for the Cluster to use (IP from PublicSubnet1)",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"InstanceType": {
			"Type": "String",
			"Default": "m5.2xlarge",
			"Description": "Select the instance type for the FortiManagers.  *** If using PAYG2Devices for LicenseType, you can only use up to a m5.xlarge. Check current Marketplace listings for PAYG options to confirm instance type selected is supported. ***",
			"AllowedValues": [
				"m5.xlarge",
				"m5.2xlarge",
				"m5.4xlarge",
				"m5.8xlarge",
				"m5.12xlarge",
				"m6i.xlarge",
				"m6i.2xlarge",
				"m6i.4xlarge",
				"m6i.8xlarge",
				"m6i.16xlarge",
				"m6i.32xlarge",
				"h1.2xlarge",
				"h1.4xlarge",
				"h1.8xlarge",
				"h1.16xlarge",
				"m6a.xlarge",
				"m6a.2xlarge",
				"m6a.4xlarge",
				"m6a.8xlarge",
				"m6a.16xlarge",
				"m6a.32xlarge",
				"m7a.xlarge",
				"m7a.2xlarge",
				"m7a.4xlarge",
				"m7a.8xlarge",
				"m7a.16xlarge",
				"m7a.32xlarge"
			]
		},
		"CIDRForInstanceAccess": {
			"Type": "String",
			"Default": "0.0.0.0/0",
			"Description": "Provide a network CIDR from which the FortiManager instances will be accessed",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"KeyPair": {
			"Type": "AWS::EC2::KeyPair::KeyName",
			"Description": "Select a keypair to associate with the FortiManagers"
		},
		"EncryptVolumes": {
			"Type": "String",
			"Description": "Select 'true' to encrypt the FortiManager instances OS and Log volumes with your account's KMS default master key for EBS.  Otherwise select false to leave unencrypted",
			"AllowedValues": [
				"true",
				"false"
			]
		},
		"InitS3Bucket": {
			"Type": "String",
			"Description": "[BYOL Only, leave blank otherwise] Provide the Init S3 Bucket name, where your config files will be created  *** the bucket should exist in the same region as this deployment for successful bootstrapping ***"
		},
		"FortiManagerVersion": {
			"Type": "String",
			"Default": "7.6.x",
			"Description": "Select the verion of FortiManager to use (latest GA AMI will be used)",
			"AllowedValues": [
				"7.4.x",
				"7.6.x"
			]
		},
		"LicenseType": {
			"Type": "String",
			"Description": "Select the license type for the FortiManagers",
			"AllowedValues": [
				"BYOL",
				"Flex",
				"PAYG10Devices",
				"PAYG30Devices",
				"PAYG100Devices",
				"PAYG500Devices"
			]
		},
		"FortiManager1SerialNumber": {
			"Type": "String",
			"Description": "[BYOL & Flex Only, leave blank for PAYG] Provide the serial number for FortiManager1 that matches it's license (ie FMG-VMTM00000001)"
		},
		"FortiManager2SerialNumber": {
			"Type": "String",
			"Description": "[BYOL & Flex Only, leave blank for PAYG] Provide the serial number for FortiManager2 that matches it's license (ie FMG-VMTM00000002)"
		},
		"FortiManager1LicenseFile": {
			"Type": "String",
			"Description": "[BYOL Only, leave blank for otherwise] Provide the name of the BYOL license file in the Init S3 Bucket for FortiManager1 (ie fmg1.lic or prefix/fmg1.lic)"
		},
		"FortiManager2LicenseFile": {
			"Type": "String",
			"Description": "[BYOL Only, leave blank for otherwise] Provide the name of the BYOL license file in the Init S3 Bucket for FortiManager2 (ie fmg2.lic or prefix/fmg2.lic)"
		},
		"FortiManager1FortiFlexToken": {
			"Type": "String",
			"Description": "[Flex Only, leave blank otherwise] Provide the FortiFlex Token for FortiManager1 (ie 1A2B3C4D5E6F7G8H9I0J)"
		},
		"FortiManager2FortiFlexToken": {
			"Type": "String",
			"Description": "[Flex Only, leave blank otherwise] Provide the FortiFlex Token for FortiManager2 (ie 2B3C4D5E6F7G8H9I0J1K)"
		}
	},
	"Mappings": {
		"FortiManagerAMISearchString": {
			"7.4.x": {
				"BYOL": "FortiManager-VM64-AWS *(7.4.*)*|os40mk0fw6472m8ak2lnzp4s",
				"Flex": "FortiManager-VM64-AWS *(7.4.*)*|os40mk0fw6472m8ak2lnzp4s",
				"PAYG2Devices": "FortiManager-VM64-AWSONDEMAND *(7.4.*)*|5j3m869sh84tixvmg9br26hkn",
				"PAYG10Devices": "FortiManager-VM64-AWSONDEMAND *(7.4.*)*|691k7ni0x5sbcj3reejxw3cy1",
				"PAYG30Devices": "FortiManager-VM64-AWSONDEMAND *(7.4.*)*|8gmpxt177zhq1vhh32l7o69wf",
				"PAYG100Devices": "FortiManager-VM64-AWSONDEMAND *(7.4.*)*|d3o35cw8hzusqeiv83jl1xuwb",
				"PAYG500Devices": "FortiManager-VM64-AWSONDEMAND *(7.4.*)*|e5s6s9r3hgizwpe9tavoxwkzv"
			},
			"7.6.x": {
				"BYOL": "FortiManager-VM64-AWS *(7.6.*)*|os40mk0fw6472m8ak2lnzp4s",
				"Flex": "FortiManager-VM64-AWS *(7.6.*)*|os40mk0fw6472m8ak2lnzp4s",
				"PAYG2Devices": "FortiManager-VM64-AWSONDEMAND *(7.6.*)*|5j3m869sh84tixvmg9br26hkn",
				"PAYG10Devices": "FortiManager-VM64-AWSONDEMAND *(7.6.*)*|691k7ni0x5sbcj3reejxw3cy1",
				"PAYG30Devices": "FortiManager-VM64-AWSONDEMAND *(7.6.*)*|8gmpxt177zhq1vhh32l7o69wf",
				"PAYG100Devices": "FortiManager-VM64-AWSONDEMAND *(7.6.*)*|d3o35cw8hzusqeiv83jl1xuwb",
				"PAYG500Devices": "FortiManager-VM64-AWSONDEMAND *(7.6.*)*|e5s6s9r3hgizwpe9tavoxwkzv"
			}
		}
	},
	"Conditions": {
		"TgwAttach": {
			"Fn::And": [
				{
					"Fn::Equals": [
						{
							"Ref": "TgwAttach"
						},
						"Yes"
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "TransitGateway"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "TransitGatewaySecurityRtb"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "TransitGatewaySpokeRtb"
								},
								""
							]
						}
					]
				}
			]
		},
		"BYOL": {
			"Fn::And": [
				{
					"Fn::Equals": [
						{
							"Ref": "LicenseType"
						},
						"BYOL"
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "InitS3Bucket"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "FortiManager1LicenseFile"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "FortiManager2LicenseFile"
								},
								""
							]
						}
					]
				}
			]
		},
		"FortiFlex": {
			"Fn::And": [
				{
					"Fn::Equals": [
						{
							"Ref": "LicenseType"
						},
						"Flex"
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "FortiManager1FortiFlexToken"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "FortiManager2FortiFlexToken"
								},
								""
							]
						}
					]
				}
			]
		}
	},
	"Resources": {
		"VPC": {
			"Type": "AWS::EC2::VPC",
			"Properties": {
				"CidrBlock": {
					"Ref": "VPCCIDR"
				},
				"EnableDnsSupport": "true",
				"EnableDnsHostnames": "true",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Join": [
								"-",
								[
									{
										"Ref": "AWS::StackName"
									},
									"VPC"
								]
							]
						}
					}
				]
			}
		},
		"PublicSub1": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "PublicSubnet1"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PublicSubnet1"
						}
					}
				]
			}
		},
		"PrivateSub1": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "PrivateSubnet1"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PrivateSubnet1"
						}
					}
				]
			}
		},
		"PublicSub2": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "PublicSubnet2"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet2"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PublicSubnet2"
						}
					}
				]
			}
		},
		"PrivateSub2": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "PrivateSubnet2"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet2"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PrivateSubnet2"
						}
					}
				]
			}
		},
		"InternetGateway": {
			"Type": "AWS::EC2::InternetGateway",
			"Properties": {
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-IGW"
						}
					}
				]
			}
		},
		"AttachGateway": {
			"Type": "AWS::EC2::VPCGatewayAttachment",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"InternetGatewayId": {
					"Ref": "InternetGateway"
				}
			}
		},
		"PublicRouteTable": {
			"Type": "AWS::EC2::RouteTable",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PublicRouteTable"
						}
					}
				]
			}
		},
		"PrivateRouteTable": {
			"Type": "AWS::EC2::RouteTable",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PrivateRouteTable"
						}
					}
				]
			}
		},
		"VPCRoute1": {
			"Type": "AWS::EC2::Route",
			"DependsOn": "AttachGateway",
			"Properties": {
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"GatewayId": {
					"Ref": "InternetGateway"
				}
			}
		},
		"VPCRoute2": {
			"Type": "AWS::EC2::Route",
			"Condition": "TgwAttach",
			"DependsOn": [
				"TransitGatewaySpokeVpcAttachment",
				"TransitGatewaySpokeVpcAttachmentAssociation"
			],
			"Properties": {
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				},
				"DestinationCidrBlock": "10.0.0.0/8",
				"TransitGatewayId": {
					"Ref": "TransitGateway"
				}
			}
		},
		"VPCRoute3": {
			"Type": "AWS::EC2::Route",
			"Condition": "TgwAttach",
			"DependsOn": [
				"TransitGatewaySpokeVpcAttachment",
				"TransitGatewaySpokeVpcAttachmentAssociation"
			],
			"Properties": {
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				},
				"DestinationCidrBlock": "172.16.0.0/12",
				"TransitGatewayId": {
					"Ref": "TransitGateway"
				}
			}
		},
		"VPCRoute4": {
			"Type": "AWS::EC2::Route",
			"Condition": "TgwAttach",
			"DependsOn": [
				"TransitGatewaySpokeVpcAttachment",
				"TransitGatewaySpokeVpcAttachmentAssociation"
			],
			"Properties": {
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				},
				"DestinationCidrBlock": "192.168.0.0/16",
				"TransitGatewayId": {
					"Ref": "TransitGateway"
				}
			}
		},
		"VPCRoute5": {
			"Type": "AWS::EC2::Route",
			"Condition": "TgwAttach",
			"DependsOn": [
				"TransitGatewaySpokeVpcAttachment",
				"TransitGatewaySpokeVpcAttachmentAssociation"
			],
			"Properties": {
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"TransitGatewayId": {
					"Ref": "TransitGateway"
				}
			}
		},
		"SubnetRouteTableAssociation1": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "PublicSub1"
				},
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation2": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "PublicSub2"
				},
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation3": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "PrivateSub1"
				},
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation4": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "PrivateSub2"
				},
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				}
			}
		},
		"TransitGatewaySpokeVpcAttachment": {
			"Type": "AWS::EC2::TransitGatewayAttachment",
			"Condition": "TgwAttach",
			"Properties": {
				"SubnetIds": [
					{
						"Ref": "PrivateSub1"
					},
					{
						"Ref": "PrivateSub2"
					}
				],
				"TransitGatewayId": {
					"Ref": "TransitGateway"
				},
				"VpcId": {
					"Ref": "VPC"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-spoke-vpc-attachment"
						}
					}
				]
			}
		},
		"TransitGatewaySpokeVpcAttachmentAssociation": {
			"Type": "AWS::EC2::TransitGatewayRouteTableAssociation",
			"DependsOn": "PrivateSub2",
			"Condition": "TgwAttach",
			"Properties": {
				"TransitGatewayAttachmentId": {
					"Ref": "TransitGatewaySpokeVpcAttachment"
				},
				"TransitGatewayRouteTableId": {
					"Ref": "TransitGatewaySpokeRtb"
				}
			}
		},
		"TransitGatewaySpokeVpcRouteTablePropagation": {
			"Type": "AWS::EC2::TransitGatewayRouteTablePropagation",
			"DependsOn": "TransitGatewaySpokeVpcAttachment",
			"Condition": "TgwAttach",
			"Properties": {
				"TransitGatewayAttachmentId": {
					"Ref": "TransitGatewaySpokeVpcAttachment"
				},
				"TransitGatewayRouteTableId": {
					"Ref": "TransitGatewaySecurityRtb"
				}
			}
		},
		"InstanceRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"ec2.amazonaws.com"
								]
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"Path": "/",
				"Policies": [
					{
						"PolicyName": "FGCPPolicy",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Sid": "BootStrapFromS3",
									"Effect": "Allow",
									"Action": [
										"s3:GetObject"
									],
									"Resource": "*"
								},
								{
									"Sid": "FmgHA7mr4p2orNewer",
									"Effect": "Allow",
									"Action": [
										"ec2:AssignPrivateIpAddresses",
										"ec2:DescribeSubnets",
										"ec2:DescribeNetworkInterfaces",
										"ec2:DescribeAddresses",
										"ec2:AssociateAddress",
										"ec2:CreateTags"
									],
									"Resource": "*"
								},
								{
									"Sid": "SDNConnectorFortiView",
									"Effect": "Allow",
									"Action": [
										"ec2:DescribeInstances",
										"ec2:DescribeRegions",
										"ec2:DescribeVpcEndpoints",
										"eks:DescribeCluster",
										"eks:ListClusters",
										"inspector:DescribeFindings",
										"inspector:ListFindings"
									],
									"Resource": "*"
								}
							]
						}
					}
				]
			}
		},
		"InstanceProfile": {
			"Type": "AWS::IAM::InstanceProfile",
			"Properties": {
				"Path": "/",
				"Roles": [
					{
						"Ref": "InstanceRole"
					}
				]
			}
		},
		"FortiManagerSecGrp": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"GroupDescription": "FortiManagerSecGrp",
				"SecurityGroupIngress": [
					{
						"Description": "Allow remote access to Fmg",
						"IpProtocol": "-1",
						"FromPort": "0",
						"ToPort": "65535",
						"CidrIp": {
							"Ref": "CIDRForInstanceAccess"
						}
					},
					{
						"Description": "Allow local VPC access to Fmg",
						"IpProtocol": "-1",
						"FromPort": "0",
						"ToPort": "65535",
						"CidrIp": {
							"Ref": "VPCCIDR"
						}
					},
					{
						"Description": "Allow 10.0.0.0/8 access to tcp port 541 Fmg",
						"IpProtocol": "tcp",
						"FromPort": "541",
						"ToPort": "541",
						"CidrIp": "10.0.0.0/8"
					},
					{
						"Description": "Allow 172.16.0.0/12 access to tcp port 541 Fmg",
						"IpProtocol": "tcp",
						"FromPort": "541",
						"ToPort": "541",
						"CidrIp": "172.16.0.0/12"
					},
					{
						"Description": "Allow 192.168.0.0/16 access to tcp port 541 Fmg",
						"IpProtocol": "tcp",
						"FromPort": "541",
						"ToPort": "541",
						"CidrIp": "192.168.0.0/16"
					},
					{
						"Description": "Allow 10.0.0.0/8 access to tcp port 514 Fmg",
						"IpProtocol": "tcp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "10.0.0.0/8"
					},
					{
						"Description": "Allow 172.16.0.0/12 access to tcp port 514 Fmg",
						"IpProtocol": "tcp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "172.16.0.0/12"
					},
					{
						"Description": "Allow 192.168.0.0/16 access to tcp port 514 Fmg",
						"IpProtocol": "tcp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "192.168.0.0/16"
					},
					{
						"Description": "Allow 10.0.0.0/8 access to udp port 514 Fmg",
						"IpProtocol": "udp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "10.0.0.0/8"
					},
					{
						"Description": "Allow 172.16.0.0/12 access to udp port 514 Fmg",
						"IpProtocol": "udp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "172.16.0.0/12"
					},
					{
						"Description": "Allow 192.168.0.0/16 access to udp port 514 Fmg",
						"IpProtocol": "udp",
						"FromPort": "514",
						"ToPort": "514",
						"CidrIp": "192.168.0.0/16"
					}
				]
			}
		},
		"FortiManagerSecGrpHArule": {
			"DependsOn": "FortiManagerSecGrp",
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {
					"Ref": "FortiManagerSecGrp"
				},
				"Description": "Allow FMGs to access each other (ICMP, VRRP, etc)",
				"IpProtocol": "-1",
				"FromPort": "0",
				"ToPort": "65535",
				"SourceSecurityGroupId": {
					"Ref": "FortiManagerSecGrp"
				}
			}
		},
		"Fmg1": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"ImageId": {
					"Fn::GetAtt": [
						"RunImageFunction",
						"ami"
					]
				},
				"InstanceType": {
					"Ref": "InstanceType"
				},
				"IamInstanceProfile": {
					"Ref": "InstanceProfile"
				},
				"KeyName": {
					"Ref": "KeyPair"
				},
				"BlockDeviceMappings": [
					{
						"DeviceName": "/dev/sda1",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "5",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					},
					{
						"DeviceName": "/dev/sdb",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "80",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					}
				],
				"NetworkInterfaces": [
					{
						"NetworkInterfaceId": {
							"Ref": "Fmg1Eni0"
						},
						"DeviceIndex": "0"
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-FortiManager1"
						}
					}
				],
				"UserData": {
					"Fn::Base64": {
						"Fn::If": [
							"BYOL",
							{
								"Fn::Sub": "{\"bucket\":\"${InitS3Bucket}\",\"region\":\"${AWS::Region}\",\"license\":\"/${FortiManager1LicenseFile}\",\"config\":\"/fmg1-config.txt\"}"
							},
							{
								"Fn::Join": [
									"\n",
									[
										"Content-Type: multipart/mixed; boundary='==Boundary=='",
										"MIME-Version: 1.0",
										"",
										"--==Boundary==",
										"Content-Type: text/x-shellscript; charset='us-ascii'",
										"MIME-Version: 1.0",
										"",
										"config system global",
										{
											"Fn::Join": [
												"",
												[
													"set hostname ",
													{
														"Ref": "AWS::StackName"
													},
													"-Fmg1"
												]
											]
										},
										"end",
										"config system interface",
										"edit port1",
										"set mode dhcp",
										"set allowaccess https ping",
										"next",
										"end",
										"config system certificate ca",
										"edit 'AmazonRootCA1'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF",
										"ADA5MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6",
										"b24gUm9vdCBDQSAxMB4XDTE1MDUyNjAwMDAwMFoXDTM4MDExNzAwMDAwMFowOTEL",
										"MAkGA1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJv",
										"b3QgQ0EgMTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALJ4gHHKeNXj",
										"ca9HgFB0fW7Y14h29Jlo91ghYPl0hAEvrAIthtOgQ3pOsqTQNroBvo3bSMgHFzZM",
										"9O6II8c+6zf1tRn4SWiw3te5djgdYZ6k/oI2peVKVuRF4fn9tBb6dNqcmzU5L/qw",
										"IFAGbHrQgLKm+a/sRxmPUDgH3KKHOVj4utWp+UhnMJbulHheb4mjUcAwhmahRWa6",
										"VOujw5H5SNz/0egwLX0tdHA114gk957EWW67c4cX8jJGKLhD+rcdqsq08p8kDi1L",
										"93FcXmn/6pUCyziKrlA4b9v7LWIbxcceVOF34GfID5yHI9Y/QCB/IIDEgEw+OyQm",
										"jgSubJrIqg0CAwEAAaNCMEAwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMC",
										"AYYwHQYDVR0OBBYEFIQYzIU07LwMlJQuCFmcx7IQTgoIMA0GCSqGSIb3DQEBCwUA",
										"A4IBAQCY8jdaQZChGsV2USggNiMOruYou6r4lK5IpDB/G/wkjUu0yKGX9rbxenDI",
										"U5PMCCjjmCXPI6T53iHTfIUJrU6adTrCC2qJeHZERxhlbI1Bjjt/msv0tadQ1wUs",
										"N+gDS63pYaACbvXy8MWy7Vu33PqUXHeeE6V/Uq2V8viTO96LXFvKWlJbYK8U90vv",
										"o/ufQJVtMVT8QtPHRh8jrdkPSHCa2XV4cdFyQzR1bldZwgJcJmApzyMZFo6IQ6XU",
										"5MsI+yMRQ+hDKXJioaldXgjUkK642M4UwtBV8ob2xJNDd2ZhwLnoQdeXeGADbkpy",
										"rqXRfboQnoZsG4q5WTP468SQvvG5",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'AmazonRootCA2'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"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",
										"4PsJYGw=",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'AmazonRootCA3'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIIBtjCCAVugAwIBAgITBmyf1XSXNmY/Owua2eiedgPySjAKBggqhkjOPQQDAjA5",
										"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
										"Um9vdCBDQSAzMB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
										"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
										"Q0EgMzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABCmXp8ZBf8ANm+gBG1bG8lKl",
										"ui2yEujSLtf6ycXYqm0fc4E7O5hrOXwzpcVOho6AF2hiRVd9RFgdszflZwjrZt6j",
										"QjBAMA8GA1UdEwEB/wQFMAMBAf8wDgYDVR0PAQH/BAQDAgGGMB0GA1UdDgQWBBSr",
										"ttvXBp43rDCGB5Fwx5zEGbF4wDAKBggqhkjOPQQDAgNJADBGAiEA4IWSoxe3jfkr",
										"BqWTrBqYaGFy+uGh0PsceGCmQ5nFuMQCIQCcAu/xlJyzlvnrxir4tiz+OpAUFteM",
										"YyRIHN8wfdVoOw==",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'AmazonRootCA4'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIIB8jCCAXigAwIBAgITBmyf18G7EEwpQ+Vxe3ssyBrBDjAKBggqhkjOPQQDAzA5",
										"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
										"Um9vdCBDQSA0MB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
										"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
										"Q0EgNDB2MBAGByqGSM49AgEGBSuBBAAiA2IABNKrijdPo1MN/sGKe0uoe0ZLY7Bi",
										"9i0b2whxIdIA6GO9mif78DluXeo9pcmBqqNbIJhFXRbb/egQbeOc4OO9X4Ri83Bk",
										"M6DLJC9wuoihKqB1+IGuYgbEgds5bimwHvouXKNCMEAwDwYDVR0TAQH/BAUwAwEB",
										"/zAOBgNVHQ8BAf8EBAMCAYYwHQYDVR0OBBYEFNPsxzplbszh2naaVvuc84ZtV+WB",
										"MAoGCCqGSM49BAMDA2gAMGUCMDqLIfG9fhGt0O9Yli/W651+kI0rz2ZVwyzjKKlw",
										"CkcO8DdZEv8tmZQoTipPNU0zWgIxAOp1AE47xDqUEpHJWEadIRNyp4iciuRMStuW",
										"1KyLa2tJElMzrdfkviT8tQp21KW8EA==",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'SFSRootCAG2'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIID7zCCAtegAwIBAgIBADANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMCVVMx",
										"EDAOBgNVBAgTB0FyaXpvbmExEzARBgNVBAcTClNjb3R0c2RhbGUxJTAjBgNVBAoT",
										"HFN0YXJmaWVsZCBUZWNobm9sb2dpZXMsIEluYy4xOzA5BgNVBAMTMlN0YXJmaWVs",
										"ZCBTZXJ2aWNlcyBSb290IENlcnRpZmljYXRlIEF1dGhvcml0eSAtIEcyMB4XDTA5",
										"MDkwMTAwMDAwMFoXDTM3MTIzMTIzNTk1OVowgZgxCzAJBgNVBAYTAlVTMRAwDgYD",
										"VQQIEwdBcml6b25hMRMwEQYDVQQHEwpTY290dHNkYWxlMSUwIwYDVQQKExxTdGFy",
										"ZmllbGQgVGVjaG5vbG9naWVzLCBJbmMuMTswOQYDVQQDEzJTdGFyZmllbGQgU2Vy",
										"dmljZXMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgLSBHMjCCASIwDQYJKoZI",
										"hvcNAQEBBQADggEPADCCAQoCggEBANUMOsQq+U7i9b4Zl1+OiFOxHz/Lz58gE20p",
										"OsgPfTz3a3Y4Y9k2YKibXlwAgLIvWX/2h/klQ4bnaRtSmpDhcePYLQ1Ob/bISdm2",
										"8xpWriu2dBTrz/sm4xq6HZYuajtYlIlHVv8loJNwU4PahHQUw2eeBGg6345AWh1K",
										"Ts9DkTvnVtYAcMtS7nt9rjrnvDH5RfbCYM8TWQIrgMw0R9+53pBlbQLPLJGmpufe",
										"hRhJfGZOozptqbXuNC66DQO4M99H67FrjSXZm86B0UVGMpZwh94CDklDhbZsc7tk",
										"6mFBrMnUVN+HL8cisibMn1lUaJ/8viovxFUcdUBgF4UCVTmLfwUCAwEAAaNCMEAw",
										"DwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYwHQYDVR0OBBYEFJxfAN+q",
										"AdcwKziIorhtSpzyEZGDMA0GCSqGSIb3DQEBCwUAA4IBAQBLNqaEd2ndOxmfZyMI",
										"bw5hyf2E3F/YNoHN2BtBLZ9g3ccaaNnRbobhiCPPE95Dz+I0swSdHynVv/heyNXB",
										"ve6SbzJ08pGCL72CQnqtKrcgfU28elUSwhXqvfdqlS5sdJ/PHLTyxQGjhdByPq1z",
										"qwubdQxtRbeOlKyWN7Wg0I8VRw7j6IPdj/3vQQF3zCepYoUz8jcI73HPdwbeyBkd",
										"iEDPfUYd/x7H4c7/I9vG+o1VTqkC50cRRj70/b17KSa7qWFiNyi2LSr2EIZkyXCn",
										"0q23KXB56jzaYyWf/Wi3MOxw+3WKt21gZ7IeyLnp2KhvAotnDU0mV3HaIPzBSlCN",
										"sSi6",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"end",
										"config system ha",
										"set failover-mode vrrp",
										"set unicast enable",
										{
											"Fn::Join": [
												"",
												[
													"set password ",
													{
														"Fn::Base64": {
															"Ref": "AWS::AccountId"
														}
													}
												]
											]
										},
										{
											"Fn::Join": [
												"",
												[
													"set vip ",
													{
														"Fn::Select": [
															"0",
															{
																"Fn::Split": [
																	"/",
																	{
																		"Ref": "ClusterIP"
																	}
																]
															}
														]
													}
												]
											]
										},
										"set vrrp-interface port1",
										"config peer",
										"edit 1",
										{
											"Fn::Join": [
												"",
												[
													"set ip ",
													{
														"Fn::Select": [
															"0",
															{
																"Fn::Split": [
																	"/",
																	{
																		"Ref": "FortiManager2PrimaryIP"
																	}
																]
															}
														]
													}
												]
											]
										},
										{
											"Fn::Join": [
												"",
												[
													"set serial-number ",
													{
														"Ref": "FortiManager2SerialNumber"
													}
												]
											]
										},
										"next",
										"end",
										"config monitored-ips",
										"edit 1",
										"set interface port1",
										{
											"Fn::Join": [
												"",
												[
													"set ip ",
													{
														"Fn::Select": [
															"0",
															{
																"Fn::Split": [
																	"/",
																	{
																		"Ref": "FortiManager2PrimaryIP"
																	}
																]
															}
														]
													}
												]
											]
										},
										"next",
										"end",
										"end",
										"",
										{
											"Fn::If": [
												"FortiFlex",
												{
													"Fn::Sub": [
														"exec vm-license ${token}",
														{
															"token": {
																"Ref": "FortiManager1FortiFlexToken"
															}
														}
													]
												},
												{
													"Ref": "AWS::NoValue"
												}
											]
										},
										"--==Boundary==--"
									]
								]
							}
						]
					}
				}
			}
		},
		"Fmg1Eni0": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": "port1",
				"GroupSet": [
					{
						"Ref": "FortiManagerSecGrp"
					}
				],
				"SourceDestCheck": "false",
				"SubnetId": {
					"Ref": "PublicSub1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-fmg1eni0"
						}
					},
					{
						"Key": "Interface",
						"Value": "eth0"
					},
					{
						"Key": "viptag",
						"Value": {
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"/",
										{
											"Ref": "ClusterIP"
										}
									]
								}
							]
						}
					}
				],
				"PrivateIpAddresses": [
					{
						"PrivateIpAddress": {
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"/",
										{
											"Ref": "FortiManager1PrimaryIP"
										}
									]
								}
							]
						},
						"Primary": "true"
					},
					{
						"PrivateIpAddress": {
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"/",
										{
											"Ref": "ClusterIP"
										}
									]
								}
							]
						},
						"Primary": "false"
					}
				]
			}
		},
		"Fmg1EIP": {
			"Type": "AWS::EC2::EIP",
			"Properties": {
				"Domain": "vpc",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-FortiManager1"
						}
					}
				]
			}
		},
		"Fmg1EIPASSOCIATION": {
			"Type": "AWS::EC2::EIPAssociation",
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"Fmg1EIP",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "Fmg1Eni0"
				},
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiManager1PrimaryIP"
								}
							]
						}
					]
				}
			},
			"DependsOn": [
				"Fmg1",
				"Fmg1Eni0",
				"Fmg1EIP"
			]
		},
		"FmgClusterEIP": {
			"Type": "AWS::EC2::EIP",
			"Properties": {
				"Domain": "vpc",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-FortiManagerCluster"
						}
					}
				]
			}
		},
		"FmgClusterEIPASSOCIATION": {
			"Type": "AWS::EC2::EIPAssociation",
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"FmgClusterEIP",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "Fmg1Eni0"
				},
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "ClusterIP"
								}
							]
						}
					]
				}
			},
			"DependsOn": [
				"Fmg1",
				"Fmg1Eni0",
				"FmgClusterEIP"
			]
		},
		"Fmg2": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"ImageId": {
					"Fn::GetAtt": [
						"RunImageFunction",
						"ami"
					]
				},
				"InstanceType": {
					"Ref": "InstanceType"
				},
				"IamInstanceProfile": {
					"Ref": "InstanceProfile"
				},
				"KeyName": {
					"Ref": "KeyPair"
				},
				"BlockDeviceMappings": [
					{
						"DeviceName": "/dev/sda1",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "5",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					},
					{
						"DeviceName": "/dev/sdb",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "80",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					}
				],
				"NetworkInterfaces": [
					{
						"NetworkInterfaceId": {
							"Ref": "Fmg2Eni0"
						},
						"DeviceIndex": "0"
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-FortiManager2"
						}
					}
				],
				"UserData": {
					"Fn::Base64": {
						"Fn::If": [
							"BYOL",
							{
								"Fn::Sub": "{\"bucket\":\"${InitS3Bucket}\",\"region\":\"${AWS::Region}\",\"license\":\"/${FortiManager2LicenseFile}\",\"config\":\"/fmg2-config.txt\"}"
							},
							{
								"Fn::Join": [
									"\n",
									[
										"Content-Type: multipart/mixed; boundary='==Boundary=='",
										"MIME-Version: 1.0",
										"",
										"--==Boundary==",
										"Content-Type: text/x-shellscript; charset='us-ascii'",
										"MIME-Version: 1.0",
										"",
										"config system global",
										{
											"Fn::Join": [
												"",
												[
													"set hostname ",
													{
														"Ref": "AWS::StackName"
													},
													"-Fmg2"
												]
											]
										},
										"end",
										"config system interface",
										"edit port1",
										"set mode dhcp",
										"set allowaccess https ping",
										"next",
										"end",
										"config system certificate ca",
										"edit 'AmazonRootCA1'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF",
										"ADA5MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6",
										"b24gUm9vdCBDQSAxMB4XDTE1MDUyNjAwMDAwMFoXDTM4MDExNzAwMDAwMFowOTEL",
										"MAkGA1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJv",
										"b3QgQ0EgMTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALJ4gHHKeNXj",
										"ca9HgFB0fW7Y14h29Jlo91ghYPl0hAEvrAIthtOgQ3pOsqTQNroBvo3bSMgHFzZM",
										"9O6II8c+6zf1tRn4SWiw3te5djgdYZ6k/oI2peVKVuRF4fn9tBb6dNqcmzU5L/qw",
										"IFAGbHrQgLKm+a/sRxmPUDgH3KKHOVj4utWp+UhnMJbulHheb4mjUcAwhmahRWa6",
										"VOujw5H5SNz/0egwLX0tdHA114gk957EWW67c4cX8jJGKLhD+rcdqsq08p8kDi1L",
										"93FcXmn/6pUCyziKrlA4b9v7LWIbxcceVOF34GfID5yHI9Y/QCB/IIDEgEw+OyQm",
										"jgSubJrIqg0CAwEAAaNCMEAwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMC",
										"AYYwHQYDVR0OBBYEFIQYzIU07LwMlJQuCFmcx7IQTgoIMA0GCSqGSIb3DQEBCwUA",
										"A4IBAQCY8jdaQZChGsV2USggNiMOruYou6r4lK5IpDB/G/wkjUu0yKGX9rbxenDI",
										"U5PMCCjjmCXPI6T53iHTfIUJrU6adTrCC2qJeHZERxhlbI1Bjjt/msv0tadQ1wUs",
										"N+gDS63pYaACbvXy8MWy7Vu33PqUXHeeE6V/Uq2V8viTO96LXFvKWlJbYK8U90vv",
										"o/ufQJVtMVT8QtPHRh8jrdkPSHCa2XV4cdFyQzR1bldZwgJcJmApzyMZFo6IQ6XU",
										"5MsI+yMRQ+hDKXJioaldXgjUkK642M4UwtBV8ob2xJNDd2ZhwLnoQdeXeGADbkpy",
										"rqXRfboQnoZsG4q5WTP468SQvvG5",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'AmazonRootCA2'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"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",
										"4PsJYGw=",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'AmazonRootCA3'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIIBtjCCAVugAwIBAgITBmyf1XSXNmY/Owua2eiedgPySjAKBggqhkjOPQQDAjA5",
										"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
										"Um9vdCBDQSAzMB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
										"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
										"Q0EgMzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABCmXp8ZBf8ANm+gBG1bG8lKl",
										"ui2yEujSLtf6ycXYqm0fc4E7O5hrOXwzpcVOho6AF2hiRVd9RFgdszflZwjrZt6j",
										"QjBAMA8GA1UdEwEB/wQFMAMBAf8wDgYDVR0PAQH/BAQDAgGGMB0GA1UdDgQWBBSr",
										"ttvXBp43rDCGB5Fwx5zEGbF4wDAKBggqhkjOPQQDAgNJADBGAiEA4IWSoxe3jfkr",
										"BqWTrBqYaGFy+uGh0PsceGCmQ5nFuMQCIQCcAu/xlJyzlvnrxir4tiz+OpAUFteM",
										"YyRIHN8wfdVoOw==",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'AmazonRootCA4'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIIB8jCCAXigAwIBAgITBmyf18G7EEwpQ+Vxe3ssyBrBDjAKBggqhkjOPQQDAzA5",
										"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
										"Um9vdCBDQSA0MB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
										"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
										"Q0EgNDB2MBAGByqGSM49AgEGBSuBBAAiA2IABNKrijdPo1MN/sGKe0uoe0ZLY7Bi",
										"9i0b2whxIdIA6GO9mif78DluXeo9pcmBqqNbIJhFXRbb/egQbeOc4OO9X4Ri83Bk",
										"M6DLJC9wuoihKqB1+IGuYgbEgds5bimwHvouXKNCMEAwDwYDVR0TAQH/BAUwAwEB",
										"/zAOBgNVHQ8BAf8EBAMCAYYwHQYDVR0OBBYEFNPsxzplbszh2naaVvuc84ZtV+WB",
										"MAoGCCqGSM49BAMDA2gAMGUCMDqLIfG9fhGt0O9Yli/W651+kI0rz2ZVwyzjKKlw",
										"CkcO8DdZEv8tmZQoTipPNU0zWgIxAOp1AE47xDqUEpHJWEadIRNyp4iciuRMStuW",
										"1KyLa2tJElMzrdfkviT8tQp21KW8EA==",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"edit 'SFSRootCAG2'",
										"set ca '-----BEGIN CERTIFICATE-----",
										"MIID7zCCAtegAwIBAgIBADANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMCVVMx",
										"EDAOBgNVBAgTB0FyaXpvbmExEzARBgNVBAcTClNjb3R0c2RhbGUxJTAjBgNVBAoT",
										"HFN0YXJmaWVsZCBUZWNobm9sb2dpZXMsIEluYy4xOzA5BgNVBAMTMlN0YXJmaWVs",
										"ZCBTZXJ2aWNlcyBSb290IENlcnRpZmljYXRlIEF1dGhvcml0eSAtIEcyMB4XDTA5",
										"MDkwMTAwMDAwMFoXDTM3MTIzMTIzNTk1OVowgZgxCzAJBgNVBAYTAlVTMRAwDgYD",
										"VQQIEwdBcml6b25hMRMwEQYDVQQHEwpTY290dHNkYWxlMSUwIwYDVQQKExxTdGFy",
										"ZmllbGQgVGVjaG5vbG9naWVzLCBJbmMuMTswOQYDVQQDEzJTdGFyZmllbGQgU2Vy",
										"dmljZXMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgLSBHMjCCASIwDQYJKoZI",
										"hvcNAQEBBQADggEPADCCAQoCggEBANUMOsQq+U7i9b4Zl1+OiFOxHz/Lz58gE20p",
										"OsgPfTz3a3Y4Y9k2YKibXlwAgLIvWX/2h/klQ4bnaRtSmpDhcePYLQ1Ob/bISdm2",
										"8xpWriu2dBTrz/sm4xq6HZYuajtYlIlHVv8loJNwU4PahHQUw2eeBGg6345AWh1K",
										"Ts9DkTvnVtYAcMtS7nt9rjrnvDH5RfbCYM8TWQIrgMw0R9+53pBlbQLPLJGmpufe",
										"hRhJfGZOozptqbXuNC66DQO4M99H67FrjSXZm86B0UVGMpZwh94CDklDhbZsc7tk",
										"6mFBrMnUVN+HL8cisibMn1lUaJ/8viovxFUcdUBgF4UCVTmLfwUCAwEAAaNCMEAw",
										"DwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYwHQYDVR0OBBYEFJxfAN+q",
										"AdcwKziIorhtSpzyEZGDMA0GCSqGSIb3DQEBCwUAA4IBAQBLNqaEd2ndOxmfZyMI",
										"bw5hyf2E3F/YNoHN2BtBLZ9g3ccaaNnRbobhiCPPE95Dz+I0swSdHynVv/heyNXB",
										"ve6SbzJ08pGCL72CQnqtKrcgfU28elUSwhXqvfdqlS5sdJ/PHLTyxQGjhdByPq1z",
										"qwubdQxtRbeOlKyWN7Wg0I8VRw7j6IPdj/3vQQF3zCepYoUz8jcI73HPdwbeyBkd",
										"iEDPfUYd/x7H4c7/I9vG+o1VTqkC50cRRj70/b17KSa7qWFiNyi2LSr2EIZkyXCn",
										"0q23KXB56jzaYyWf/Wi3MOxw+3WKt21gZ7IeyLnp2KhvAotnDU0mV3HaIPzBSlCN",
										"sSi6",
										"-----END CERTIFICATE-----'",
										"set comment 'https://www.amazontrust.com/repository/'",
										"next",
										"end",
										"config system ha",
										"set failover-mode vrrp",
										"set unicast enable",
										{
											"Fn::Join": [
												"",
												[
													"set password ",
													{
														"Fn::Base64": {
															"Ref": "AWS::AccountId"
														}
													}
												]
											]
										},
										{
											"Fn::Join": [
												"",
												[
													"set vip ",
													{
														"Fn::Select": [
															"0",
															{
																"Fn::Split": [
																	"/",
																	{
																		"Ref": "ClusterIP"
																	}
																]
															}
														]
													}
												]
											]
										},
										"set vrrp-interface port1",
										"config peer",
										"edit 1",
										{
											"Fn::Join": [
												"",
												[
													"set ip ",
													{
														"Fn::Select": [
															"0",
															{
																"Fn::Split": [
																	"/",
																	{
																		"Ref": "FortiManager1PrimaryIP"
																	}
																]
															}
														]
													}
												]
											]
										},
										{
											"Fn::Join": [
												"",
												[
													"set serial-number ",
													{
														"Ref": "FortiManager1SerialNumber"
													}
												]
											]
										},
										"next",
										"end",
										"config monitored-ips",
										"edit 1",
										"set interface port1",
										{
											"Fn::Join": [
												"",
												[
													"set ip ",
													{
														"Fn::Select": [
															"0",
															{
																"Fn::Split": [
																	"/",
																	{
																		"Ref": "FortiManager1PrimaryIP"
																	}
																]
															}
														]
													}
												]
											]
										},
										"next",
										"end",
										"end",
										"",
										{
											"Fn::If": [
												"FortiFlex",
												{
													"Fn::Sub": [
														"exec vm-license ${token}",
														{
															"token": {
																"Ref": "FortiManager2FortiFlexToken"
															}
														}
													]
												},
												{
													"Ref": "AWS::NoValue"
												}
											]
										},
										"--==Boundary==--"
									]
								]
							}
						]
					}
				}
			}
		},
		"Fmg2Eni0": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": "port1",
				"GroupSet": [
					{
						"Ref": "FortiManagerSecGrp"
					}
				],
				"SourceDestCheck": "false",
				"SubnetId": {
					"Ref": "PublicSub1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-fmg2eni0"
						}
					},
					{
						"Key": "Interface",
						"Value": "eth0"
					},
					{
						"Key": "viptag",
						"Value": {
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"/",
										{
											"Ref": "ClusterIP"
										}
									]
								}
							]
						}
					}
				],
				"PrivateIpAddresses": [
					{
						"PrivateIpAddress": {
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"/",
										{
											"Ref": "FortiManager2PrimaryIP"
										}
									]
								}
							]
						},
						"Primary": "true"
					}
				]
			}
		},
		"Fmg2EIP": {
			"Type": "AWS::EC2::EIP",
			"Properties": {
				"Domain": "vpc",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-FortiManager2"
						}
					}
				]
			}
		},
		"Fmg2EIPASSOCIATION": {
			"Type": "AWS::EC2::EIPAssociation",
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"Fmg2EIP",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "Fmg2Eni0"
				},
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiManager2PrimaryIP"
								}
							]
						}
					]
				}
			},
			"DependsOn": [
				"Fmg2",
				"Fmg2Eni0",
				"Fmg2EIP"
			]
		},
		"LambdaRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"lambda.amazonaws.com"
								]
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"Path": "/",
				"Policies": [
					{
						"PolicyName": "S3AccessRole",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Effect": "Allow",
									"Action": [
										"s3:PutObject",
										"ec2:DescribeImages"
									],
									"Resource": "*"
								},
								{
									"Effect": "Allow",
									"Action": [
										"logs:*"
									],
									"Resource": "*"
								}
							]
						}
					}
				]
			}
		},
		"ImageFunction": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": {
						"Fn::Join": [
							"\n",
							[
								"import boto3",
								"import cfnresponse",
								"import logging",
								"import json",
								"logger = logging.getLogger()",
								"logger.setLevel(logging.INFO)",
								"client = boto3.client('ec2')",
								"",
								"def handler(event, context):",
								"    if event['RequestType'] == 'Create':",
								"        logger.info('<-- event received: {}'.format(json.dumps(event)))",
								"        searchString = event['ResourceProperties']['SearchString']",
								"        productCode =  event['ResourceProperties']['ProductCode']",
								"    else:",
								"        responseData = {'msg':'200'}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"        return None",
								"",
								"    try:",
								"        resp = client.describe_images(",
								"            Filters=[{'Name': 'name', 'Values': [searchString]}, {'Name': 'product-code', 'Values': [productCode]}],",
								"            Owners=['aws-marketplace']",
								"        )",
								"    except Exception as error:",
								"        logger.error('<--!! Exception: {}'.format(error))",
								"        responseData = {'msg':'Exception: {}'.format(error)}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								"",
								"    if resp['ResponseMetadata']['HTTPStatusCode'] == 200 and resp['Images'] != []:",
								"        ami_dict = {}",
								"        ami_list = []",
								"        for entry in resp['Images']:",
								"            key = entry['CreationDate']",
								"            ami_dict[key] = entry['ImageId']",
								"        ami_list = sorted(ami_dict, reverse = True)",
								"        logger.info('--> found latest AMI: {}, {}, {} {}'.format(ami_dict[ami_list[0]], ami_list[0], searchString, productCode))",
								"        responseData = {'ami': ami_dict[ami_list[0]]}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"    else:",
								"        logger.error('!!--> Unable to find AMI {} {} in describe_images response! {}'.format(searchString, productCode, resp))",
								"        responseData = {'msg':'Unable to find AMI {} {} in describe_images response! {}'.format(searchString, productCode,resp)}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								""
							]
						]
					}
				},
				"Role": {
					"Fn::GetAtt": [
						"LambdaRole",
						"Arn"
					]
				},
				"Timeout": 120,
				"Handler": "index.handler",
				"Runtime": "python3.12",
				"MemorySize": 128
			}
		},
		"RunImageFunction": {
			"Type": "Custom::ImageFunction",
			"Properties": {
				"ServiceToken": {
					"Fn::GetAtt": [
						"ImageFunction",
						"Arn"
					]
				},
				"SearchString": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"|",
								{
									"Fn::FindInMap": [
										"FortiManagerAMISearchString",
										{
											"Ref": "FortiManagerVersion"
										},
										{
											"Ref": "LicenseType"
										}
									]
								}
							]
						}
					]
				},
				"ProductCode": {
					"Fn::Select": [
						"1",
						{
							"Fn::Split": [
								"|",
								{
									"Fn::FindInMap": [
										"FortiManagerAMISearchString",
										{
											"Ref": "FortiManagerVersion"
										},
										{
											"Ref": "LicenseType"
										}
									]
								}
							]
						}
					]
				}
			}
		},
		"InitFunction": {
			"Type": "AWS::Lambda::Function",
			"Condition": "BYOL",
			"Properties": {
				"Code": {
					"ZipFile": {
						"Fn::Join": [
							"\n",
							[
								"import ast",
								"import boto3",
								"import cfnresponse",
								"import json",
								"import logging",
								"logger = logging.getLogger()",
								"logger.setLevel(logging.INFO)",
								"s3 = boto3.client('s3')",
								"",
								"template = '''\\",
								"config system global",
								"set hostname {Hostname}",
								"end",
								"config system interface",
								"edit port1",
								"set mode dhcp",
								"set allowaccess https ping",
								"next",
								"end",
								"config system certificate ca",
								"edit 'AmazonRootCA1'",
								"set ca '-----BEGIN CERTIFICATE-----",
								"MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF",
								"ADA5MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6",
								"b24gUm9vdCBDQSAxMB4XDTE1MDUyNjAwMDAwMFoXDTM4MDExNzAwMDAwMFowOTEL",
								"MAkGA1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJv",
								"b3QgQ0EgMTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALJ4gHHKeNXj",
								"ca9HgFB0fW7Y14h29Jlo91ghYPl0hAEvrAIthtOgQ3pOsqTQNroBvo3bSMgHFzZM",
								"9O6II8c+6zf1tRn4SWiw3te5djgdYZ6k/oI2peVKVuRF4fn9tBb6dNqcmzU5L/qw",
								"IFAGbHrQgLKm+a/sRxmPUDgH3KKHOVj4utWp+UhnMJbulHheb4mjUcAwhmahRWa6",
								"VOujw5H5SNz/0egwLX0tdHA114gk957EWW67c4cX8jJGKLhD+rcdqsq08p8kDi1L",
								"93FcXmn/6pUCyziKrlA4b9v7LWIbxcceVOF34GfID5yHI9Y/QCB/IIDEgEw+OyQm",
								"jgSubJrIqg0CAwEAAaNCMEAwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMC",
								"AYYwHQYDVR0OBBYEFIQYzIU07LwMlJQuCFmcx7IQTgoIMA0GCSqGSIb3DQEBCwUA",
								"A4IBAQCY8jdaQZChGsV2USggNiMOruYou6r4lK5IpDB/G/wkjUu0yKGX9rbxenDI",
								"U5PMCCjjmCXPI6T53iHTfIUJrU6adTrCC2qJeHZERxhlbI1Bjjt/msv0tadQ1wUs",
								"N+gDS63pYaACbvXy8MWy7Vu33PqUXHeeE6V/Uq2V8viTO96LXFvKWlJbYK8U90vv",
								"o/ufQJVtMVT8QtPHRh8jrdkPSHCa2XV4cdFyQzR1bldZwgJcJmApzyMZFo6IQ6XU",
								"5MsI+yMRQ+hDKXJioaldXgjUkK642M4UwtBV8ob2xJNDd2ZhwLnoQdeXeGADbkpy",
								"rqXRfboQnoZsG4q5WTP468SQvvG5",
								"-----END CERTIFICATE-----'",
								"set comment 'https://www.amazontrust.com/repository/'",
								"next",
								"edit 'AmazonRootCA2'",
								"set ca '-----BEGIN CERTIFICATE-----",
								"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",
								"4PsJYGw=",
								"-----END CERTIFICATE-----'",
								"set comment 'https://www.amazontrust.com/repository/'",
								"next",
								"edit 'AmazonRootCA3'",
								"set ca '-----BEGIN CERTIFICATE-----",
								"MIIBtjCCAVugAwIBAgITBmyf1XSXNmY/Owua2eiedgPySjAKBggqhkjOPQQDAjA5",
								"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
								"Um9vdCBDQSAzMB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
								"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
								"Q0EgMzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABCmXp8ZBf8ANm+gBG1bG8lKl",
								"ui2yEujSLtf6ycXYqm0fc4E7O5hrOXwzpcVOho6AF2hiRVd9RFgdszflZwjrZt6j",
								"QjBAMA8GA1UdEwEB/wQFMAMBAf8wDgYDVR0PAQH/BAQDAgGGMB0GA1UdDgQWBBSr",
								"ttvXBp43rDCGB5Fwx5zEGbF4wDAKBggqhkjOPQQDAgNJADBGAiEA4IWSoxe3jfkr",
								"BqWTrBqYaGFy+uGh0PsceGCmQ5nFuMQCIQCcAu/xlJyzlvnrxir4tiz+OpAUFteM",
								"YyRIHN8wfdVoOw==",
								"-----END CERTIFICATE-----'",
								"set comment 'https://www.amazontrust.com/repository/'",
								"next",
								"edit 'AmazonRootCA4'",
								"set ca '-----BEGIN CERTIFICATE-----",
								"MIIB8jCCAXigAwIBAgITBmyf18G7EEwpQ+Vxe3ssyBrBDjAKBggqhkjOPQQDAzA5",
								"MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g",
								"Um9vdCBDQSA0MB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG",
								"A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg",
								"Q0EgNDB2MBAGByqGSM49AgEGBSuBBAAiA2IABNKrijdPo1MN/sGKe0uoe0ZLY7Bi",
								"9i0b2whxIdIA6GO9mif78DluXeo9pcmBqqNbIJhFXRbb/egQbeOc4OO9X4Ri83Bk",
								"M6DLJC9wuoihKqB1+IGuYgbEgds5bimwHvouXKNCMEAwDwYDVR0TAQH/BAUwAwEB",
								"/zAOBgNVHQ8BAf8EBAMCAYYwHQYDVR0OBBYEFNPsxzplbszh2naaVvuc84ZtV+WB",
								"MAoGCCqGSM49BAMDA2gAMGUCMDqLIfG9fhGt0O9Yli/W651+kI0rz2ZVwyzjKKlw",
								"CkcO8DdZEv8tmZQoTipPNU0zWgIxAOp1AE47xDqUEpHJWEadIRNyp4iciuRMStuW",
								"1KyLa2tJElMzrdfkviT8tQp21KW8EA==",
								"-----END CERTIFICATE-----'",
								"set comment 'https://www.amazontrust.com/repository/'",
								"next",
								"edit 'SFSRootCAG2'",
								"set ca '-----BEGIN CERTIFICATE-----",
								"MIID7zCCAtegAwIBAgIBADANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMCVVMx",
								"EDAOBgNVBAgTB0FyaXpvbmExEzARBgNVBAcTClNjb3R0c2RhbGUxJTAjBgNVBAoT",
								"HFN0YXJmaWVsZCBUZWNobm9sb2dpZXMsIEluYy4xOzA5BgNVBAMTMlN0YXJmaWVs",
								"ZCBTZXJ2aWNlcyBSb290IENlcnRpZmljYXRlIEF1dGhvcml0eSAtIEcyMB4XDTA5",
								"MDkwMTAwMDAwMFoXDTM3MTIzMTIzNTk1OVowgZgxCzAJBgNVBAYTAlVTMRAwDgYD",
								"VQQIEwdBcml6b25hMRMwEQYDVQQHEwpTY290dHNkYWxlMSUwIwYDVQQKExxTdGFy",
								"ZmllbGQgVGVjaG5vbG9naWVzLCBJbmMuMTswOQYDVQQDEzJTdGFyZmllbGQgU2Vy",
								"dmljZXMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgLSBHMjCCASIwDQYJKoZI",
								"hvcNAQEBBQADggEPADCCAQoCggEBANUMOsQq+U7i9b4Zl1+OiFOxHz/Lz58gE20p",
								"OsgPfTz3a3Y4Y9k2YKibXlwAgLIvWX/2h/klQ4bnaRtSmpDhcePYLQ1Ob/bISdm2",
								"8xpWriu2dBTrz/sm4xq6HZYuajtYlIlHVv8loJNwU4PahHQUw2eeBGg6345AWh1K",
								"Ts9DkTvnVtYAcMtS7nt9rjrnvDH5RfbCYM8TWQIrgMw0R9+53pBlbQLPLJGmpufe",
								"hRhJfGZOozptqbXuNC66DQO4M99H67FrjSXZm86B0UVGMpZwh94CDklDhbZsc7tk",
								"6mFBrMnUVN+HL8cisibMn1lUaJ/8viovxFUcdUBgF4UCVTmLfwUCAwEAAaNCMEAw",
								"DwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYwHQYDVR0OBBYEFJxfAN+q",
								"AdcwKziIorhtSpzyEZGDMA0GCSqGSIb3DQEBCwUAA4IBAQBLNqaEd2ndOxmfZyMI",
								"bw5hyf2E3F/YNoHN2BtBLZ9g3ccaaNnRbobhiCPPE95Dz+I0swSdHynVv/heyNXB",
								"ve6SbzJ08pGCL72CQnqtKrcgfU28elUSwhXqvfdqlS5sdJ/PHLTyxQGjhdByPq1z",
								"qwubdQxtRbeOlKyWN7Wg0I8VRw7j6IPdj/3vQQF3zCepYoUz8jcI73HPdwbeyBkd",
								"iEDPfUYd/x7H4c7/I9vG+o1VTqkC50cRRj70/b17KSa7qWFiNyi2LSr2EIZkyXCn",
								"0q23KXB56jzaYyWf/Wi3MOxw+3WKt21gZ7IeyLnp2KhvAotnDU0mV3HaIPzBSlCN",
								"sSi6",
								"-----END CERTIFICATE-----'",
								"set comment 'https://www.amazontrust.com/repository/'",
								"next",
								"end",
								"config system ha",
								"set failover-mode vrrp",
								"set unicast enable",
								"set password {HaPassword}",
								"set vip {HaVip}",
								"set vrrp-interface port1",
								"config peer",
								"edit 1",
								"set ip {HaPeerIp}",
								"set serial-number {HaPeerSn}",
								"next",
								"end",
								"config monitored-ips",
								"edit 1",
								"set interface port1",
								"set ip {HaPeerIp}",
								"next",
								"end",
								"end",
								"",
								"\\",
								"'''",
								"",
								"def handler(event, context):",
								"    if event['RequestType'] == 'Create':",
								"        logger.info('<-- event received: {}'.format(json.dumps(event)))",
								"        dict1 = ast.literal_eval(event['ResourceProperties']['FMG1Info'])",
								"        dict2 = ast.literal_eval(event['ResourceProperties']['FMG2Info'])",
								"        fmg1_conf = template.format(**dict1)",
								"        fmg2_conf = template.format(**dict2)",
								"        fmg1_result = False",
								"        fmg2_result = False",
								"    else:",
								"        responseData = {'msg':'200'}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"        return None",
								"",
								"    try:",
								"        response = s3.put_object(Body=fmg1_conf, Bucket=event['ResourceProperties']['S3Bucket'], Key='fmg1-config.txt')",
								"    except Exception as error:",
								"        logger.error('<--!! Exception: {}'.format(error))",
								"        responseData = {'msg':'Exception: {}'.format(error)}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								"        return None",
								"",
								"    if response['ResponseMetadata']['HTTPStatusCode'] == 200:",
								"        responseData = {'msg':'success'}",
								"        fmg1_result = True",
								"        logger.info('<-- s3 put_object fmg1-config.txt successful')",
								"    else:",
								"        responseData = {'msg':'error'}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								"",
								"    try:",
								"        response = s3.put_object(Body=fmg2_conf, Bucket=event['ResourceProperties']['S3Bucket'], Key='fmg2-config.txt')",
								"    except Exception as error:",
								"        logger.error('<--!! Exception: {}'.format(error))",
								"        responseData = {'msg':'Exception: {}'.format(error)}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								"        return None",
								"",
								"    if response['ResponseMetadata']['HTTPStatusCode'] == 200:",
								"        responseData = {'msg':'success'}",
								"        fmg2_result = True",
								"        logger.info('<-- s3 put_object fmg2-config.txt successful')",
								"    else:",
								"        responseData = {'msg':'error'}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								"",
								"    if fmg1_result is True and fmg2_result is True:",
								"        responseData = {'msg':'200'}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"    else:",
								"        responseData = {'msg':'error'}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								""
							]
						]
					}
				},
				"Role": {
					"Fn::GetAtt": [
						"LambdaRole",
						"Arn"
					]
				},
				"Timeout": 120,
				"Handler": "index.handler",
				"Runtime": "python3.12",
				"MemorySize": 128
			}
		},
		"RunInitFunction": {
			"Type": "Custom::InitFunction",
			"Condition": "BYOL",
			"Properties": {
				"ServiceToken": {
					"Fn::GetAtt": [
						"InitFunction",
						"Arn"
					]
				},
				"S3Bucket": {
					"Ref": "InitS3Bucket"
				},
				"FMG1Info": {
					"Fn::Join": [
						"",
						[
							"{",
							"'Hostname':'",
							{
								"Fn::Join": [
									"",
									[
										{
											"Ref": "AWS::StackName"
										},
										"-Fmg1"
									]
								]
							},
							"',",
							"'HaPassword':',",
							{
								"Fn::Join": [
									"",
									[
										"set password ",
										{
											"Fn::Base64": {
												"Ref": "AWS::AccountId"
											}
										}
									]
								]
							},
							"',",
							"'HaPeerIp':'",
							{
								"Fn::Select": [
									"0",
									{
										"Fn::Split": [
											"/",
											{
												"Ref": "FortiManager2PrimaryIP"
											}
										]
									}
								]
							},
							"',",
							"'HaPeerSn':'",
							{
								"Ref": "FortiManager2SerialNumber"
							},
							"',",
							"'HaVip':'",
							{
								"Fn::Select": [
									"0",
									{
										"Fn::Split": [
											"/",
											{
												"Ref": "ClusterIP"
											}
										]
									}
								]
							},
							"'",
							"}"
						]
					]
				},
				"FMG2Info": {
					"Fn::Join": [
						"",
						[
							"{",
							"'Hostname':'",
							{
								"Fn::Join": [
									"",
									[
										{
											"Ref": "AWS::StackName"
										},
										"-Fmg2"
									]
								]
							},
							"',",
							"'HaPassword':',",
							{
								"Fn::Join": [
									"",
									[
										"set password ",
										{
											"Fn::Base64": {
												"Ref": "AWS::AccountId"
											}
										}
									]
								]
							},
							"',",
							"'HaPeerIp':'",
							{
								"Fn::Select": [
									"0",
									{
										"Fn::Split": [
											"/",
											{
												"Ref": "FortiManager1PrimaryIP"
											}
										]
									}
								]
							},
							"',",
							"'HaPeerSn':'",
							{
								"Ref": "FortiManager1SerialNumber"
							},
							"',",
							"'HaVip':'",
							{
								"Fn::Select": [
									"0",
									{
										"Fn::Split": [
											"/",
											{
												"Ref": "ClusterIP"
											}
										]
									}
								]
							},
							"'",
							"}"
						]
					]
				}
			}
		}
	},
	"Outputs": {
		"Username": {
			"Value": "admin",
			"Description": "Username for the FortiManagers"
		},
		"Password": {
			"Value": "The instance ID of each FortiManager",
			"Description": "Initial password for the FortiManagers"
		},
		"FortiManager1LoginURL": {
			"Value": {
				"Fn::Sub": "https://${Fmg1EIP}"
			},
			"Description": "Login URL for FortiManager1"
		},
		"FortiManager2LoginURL": {
			"Value": {
				"Fn::Sub": "https://${Fmg2EIP}"
			},
			"Description": "Login URL for FortiManager2"
		},
		"ClusterLoginURL": {
			"Value": {
				"Fn::Sub": "https://${FmgClusterEIP}"
			},
			"Description": "Login URL for Cluster"
		}
	}
}